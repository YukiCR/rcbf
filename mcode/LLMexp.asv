% LLMexp.m
% the main script to cooperate LLM with distributer safety filter

clear all, clc, close all

dt_init = 0.5; % time interval of euler integration
N = 1000; % number of steps
n_agent = 6;

CWModel.setgetdt(dt_init);
CWModel.setgetsteps(N);

v_init = [0;0;0];

% starting position of agents
%      x    y    z
p1 =  [80,   0,    0;
       20,  -20,  -20;
       20,  20,   20;
       60,   20,   20;
       60,  -20,  -20;
       0,  0,    0];

% ending position of agents
%      x    y    z
p2 =  [0,   0,    0;
       60,   20,   20;
       60,  -20,  -20;
       20,  -20,  -20;
       20,  20,   20;
        80,  0,    0];

% add the LLM package
% install the package from
% https://github.com/matlab-deep-learning/llms-with-matlab.git
addpath("/home/chengrui/wk/llms-with-matlab/");

% the background prompt for the priority assignment task
backgroundPrompt = fileread("background/background.txt");

model = ollamaChat("gemma3:12b", ...
    "You are responsible for assigning priority for satellite swarms" + ...
     " this is the guideline you should follow: " + backgroundPrompt, ...
     "Temperature", 0.0);

% set the response format
formatStruct = struct("PriorityArray", ones(1, n_agent));

%% get priority assignment form LLM

% the question to LLM
form = 2;

switch form
    case 1
        question = "We now have 6 satellites, with satellite 1 mission critical. All other satellites are backup satellites. Give me the answer.";
    case 2
        question = "We now have 6 satellites, with satellite 1 mission critical. All other satellites are low fuel satellites. Give me the answer.";
    case 3
        question = "We now have 6 satellites, with all satellites are the same. Give me the answer.";
end

% generate the response
disp("getting result from LLM")
llmans = generate(model,question, "ResponseFormat", formatStruct);
llmans.PriorityArray

% get the priority matrix
priorityArr = llmans.PriorityArray;
priorityMatirx = zeros(n_agent, n_agent);
% construct priority matrix by weight of agent i over agent j
for i = 1:n_agent
    for j = i+1:n_agent
        priorityMatirx(i,j) = priorityArr(i) / (priorityArr(i) + priorityArr(j));
        priorityMatirx(j,i) = 1 - priorityMatirx(i,j);
    end
end

%% simulation
% init agent cell
agentCell = cell(1, n_agent);
for i = 1:n_agent
    agentCell{i} = CWModel(p1(i, :)', v_init, p2(i, :)');
end

firstArriveFlag = false;
% iterate for N steps, record the state of the system in history
for i = 1:N
    senseMat = zeros(length(agentCell), 7);
    for j = 1:length(agentCell)
        % get the state of the agents for sensing
        senseMat(j, :) = [agentCell{j}.p', agentCell{j}.v', agentCell{j}.r];
    end
    U_safe = zeros(N*3, 1);
    for j = 1:length(agentCell)
        senseMatAgentj = senseMat((1:length(agentCell)~=j), :);
        u = agentCell{j}.getPIDcontrol();
        privilegeArray = priorityMatirx(j, :);
        privilegeArray(j) = [];
        u_safe = agentCell{j}.distributedSafeFiltering(u, senseMatAgentj, privilegeArray');
        U_safe((j-1)*3+1:(j-1)*3+3) = u_safe;
    end
    % step forward for each agent
    for j=1:length(agentCell)
        u_safe = U_safe((j-1)*3+1:(j-1)*3+3);
        agentCell{j}.stepForward(u_safe);
    end
    if norm(agentCell{1}.p - p2(1, :)') < 0.1 && ~firstArriveFlag
        disp("agent 1 arrived at step " + num2str(i))
        firstArriveFlag = true;
    end
end

% =========== plotting =================
% plot the state of the system
labelFontSize = 12;
legendFontSize = 11;
width = 5;  
height = 5;  
xbound = [0 85];
ybound = [-30 30];
zbound = [-30 30];

figure

% set
colororder("gem12");
C = colororder;

hold on 
for i = 1:length(agentCell)
    agentCell{i}.plotHistory('color', C(mod(i+1, length(C)), :));
end
hold off

% legend and labels
legend({'',  '$i$-th trajectory', '$i$-th starting direction', '$i$-th goal'}, 'Interpreter', 'latex','FontSize', legendFontSize, 'Position',[0.595575008338412,0.762587579305987,0.39670016253436,0.120185183595728]);
xlabel('$x (\mathrm{m})$', 'Interpreter', 'latex', 'FontSize', labelFontSize);
ylabel('$y (\mathrm{m})$', 'Interpreter', 'latex', 'FontSize', labelFontSize);
zlabel('$z (\mathrm{m})$', 'Interpreter', 'latex', 'FontSize', labelFontSize);

view(-10, 15)
axis equal
xlim(xbound)
ylim(ybound)
zlim(zbound)

% axes settigs
ax = gca;
ax.Box = "off";
ax.XLim = xbound;
ax.XGrid = "on";
ax.YGrid = "on";
ax.ZGrid = "on";
ax.FontSizeMode = 'manual';   % disable auto zoom
ax.FontSize = labelFontSize;
ax.FontName = "Times New Roman";
ax.XAxis.FontName = "Times New Roman";
ax.YAxis.FontName = "Times New Roman";
ax.ZAxis.FontName = "Times New Roman";

set(gca, 'LooseInset', [0,0,0,0]);
fig = gcf;
set(fig, 'Units', 'inches', 'Position', [1, 1, width, height]);